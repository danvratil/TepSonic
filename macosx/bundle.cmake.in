SET(DIRS @QT_LIBRARY_DIRS@;@QT_PLUGINS_DIR@;@CMAKE_INSTALL_PREFIX@/Contents/plugins/)

file(COPY @QT_LIBRARY_DIR@/QtGui.framework/Resources/qt_menu.nib
     DESTINATION @CMAKE_INSTALL_PREFIX@/tepsonic.app/Contents/Resources)

file(WRITE @CMAKE_INSTALL_PREFIX@/tepsonic.app/Contents/Resources/qt.conf "[Paths]
Plugins = plugins")

message(STATUS "Searching for Qt plugs in: @QT_PLUGINS_DIR@/*@CMAKE_SHARED_LIBRARY_SUFFIX@")
file(COPY @QT_PLUGINS_DIR@/
        DESTINATION @CMAKE_INSTALL_PREFIX@/tepsonic.app/Contents/plugins/
        REGEX "(designer|script|debug|mysql|psql|odbc|ico|gif)" EXCLUDE)

message(STATUS "Searching for plugs in bundle: @CMAKE_INSTALL_PREFIX@/tepsonic.app/Contents/plugins/*@CMAKE_SHARED_LIBRARY_SUFFIX@")
file(GLOB_RECURSE inplugs
        @CMAKE_INSTALL_PREFIX@/tepsonic.app/Contents/plugins/*@CMAKE_SHARED_LIBRARY_SUFFIX@)

#message(STATUS "Dylibs: ${inplugs}")
#message(STATUS "DIR: ${DIRS}")

include(BundleUtilities)
fixup_bundle(@CMAKE_INSTALL_PREFIX@/tepsonic.app "${inplugs}" @CMAKE_INSTALL_PREFIX@/Contents/plugins/)#${DIRS} )

foreach (item IN LISTS inplugs)
    #message(STATUS "IN: ${item}")
    get_filename_component(fname ${item} NAME)
    message(STATUS "Moving ${fname} back to plugins tree: ${item}")
    #message(STATUS "    ${fname}")
    #message(STATUS " src: @CMAKE_INSTALL_PREFIX@/tepsonic.app/Contents/MacOS/${fname}")
    #message(STATUS " tgt: ${item}")
    execute_process(COMMAND mv @CMAKE_INSTALL_PREFIX@/tepsonic.app/Contents/MacOS/${fname} ${item})
endforeach()
    
